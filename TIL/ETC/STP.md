# 스패닝 트리 프로토콜
스패닝 트리 알고리즘에 기반한 프로토콜로 `스위치`에서 적용되는 프로토콜이다.

## STP를 이해하기 위한 2가지
1. 브리지 ID
    총 64비트(8바이트) 크기로 되어있어 Bridge Priority(16비트[2바이트], 유동), MAC Address(48비트[6바이트], 고정)로 이루어져있다.

2. Path Cost
    장비 사이에 연결되어 있는 경로를 이용하기 위한 비용으로 브릿지의 거리 및 링크 속도를 알아내기 위한 값이다.

## STP의 구성
스패닝 트리는 단위 네트워크당 하나의 `Root Bridge`를 가지며 이를 제외한 나머지 `Non Root Bridge`는 하나의 `Root Port`를 가진다. 추가로 단위 세그먼트당 하나씩의 Designate<sup>*지정된</sup> 포트를 갖는다.

## STP 우선순위
1. 누가 더 작은 Root BID를 가지는가
2. 루트 브릿지로 향하는 Path cost는 누가 더 작은가
3. 누구의 BID가 작은가
4. 누구의 포트 ID가 작은가

## 대장 브릿지 선출
모든 스위치는 프로토콜에 따라 가장 먼저 Root를 선출하도록 약속되어있다. 그렇기에 연결되어 있는 모든 스위치들이 가장 먼저 하는 것은 `BPDU(Bridge Protocol Data Unit)` 교환으로 서로의 `BID`가 포함된 정보를 교환하는 과정을 거치게 되며 낮은 BID, 즉 STP 우선순위 결정에 따라 루트 브릿지가 결정되며 이후 새로운 스위치가 연결된다면 `Root Bridge`의 BID와 새로운 스위치의 BID를 교환하여 새로운 `Root Bridge`를 선출하게 된다.

### 우선순위를 변경하고 싶다면?
브릿지의 우선순위는 BID에 따라, 정확히는 BID가 가진 `Bridge Priority`에 따라 결정되지만 고정값이 아니기 때문에 관리자에 의해 임의적으로 변경이 가능하다.

# 스패닝 트리의 5가지 상태 변화 / STP 재편성
STP는 5가지의 과정을 통해 여러 스위치가 하나의 트리로 구성될 수 있다. 이는 하나의 생명주기와 유사하며 새로운 `BPDU`이 감지되면, 다시 말해 새로운 스위치의 접근이 확인되면 5가지의 과정을 다시 반복하게 되며 각 상태에서 예외사항이 발생할 경우 특정 단계로 돌아가 다시 작업을 시작하게 된다.

# STP의 5가지 상태
- Disable
  - 스위치의 전원이 없거나 사용할 수 없는 상태
- Blocking
  - 스위치의 사용이 확인되고 해당 스위치의 `BPDU`가 각 스위치와 교환되는 상태
    - 이 단계에서 ROOT BRIDGE, ROOT PORT, DESIGNATED, Non-DESIGNATED가 선출되어 하나의 트리가 생성되는 단계
    - `BPDU`만 교환하며 Mac 정보와 일반 데이터 정보는 교환하지 않음
- Listening
  - 이전 블로킹 상태가 종료된 상태로 주관적인 해석으로 리스닝 상태를 `15초간` 대기하며 구성된 스패닝 트리를 검증하는 상태로 해석한다. 이 뜻은 언제든지 새로운 `BPDU`의 접근이 확인될 수 있으며 이 경우 이전 단계 블로킹 단계로 돌아가 작업을 반복하게 된다.
- Learning
  - 최초로 `Mac-address`를 학습하는 단계로 이 단계에서 `Root switch`는 맥 어드레스 테이블(브릿지 테이블)을 생성한다.
  - 해당 단계 또한 `15초` 동안 상태를 유지한다.
- Forwarding
  - 데이터 교환을 위한 최종 상태

# STP 재편성
모든 스위치가 정상적으로 통신이 이루어지는 도중 세그먼트가 끊어지는 상황이 발생한다면 ROOT BRIDGE가 보내는 정보를 세그먼트의 주인 스위치는 받지 못하게 될 것이다. 이 경우 해당 스위치는 자신의 `MAX Age`를 카운트하여 대기 상태에 들어가게 되고 정해진 시간 동안 정보가 들어오지 않는다면 해당 스위치가 가지는 또 다른 포트 `Non-Designated` 포트를 개방하여 5가지 상태 변화를 통해 새로운 스패닝 트리를 구성한다.

## 새로운 스패닝 트리가 가지는 딜레이 타임의 문제
5가지 상태를 지나기 위해서는 기본적으로 약 `3단계 + 4단계`의 과정을 통해 총 30초 간의 정보를 교환하게 되는데 트리를 재편성할 경우 `Max_Age + 3단계 + 4단계`의 과정에서 총 50초의 딜레이가 발생하게 된다. 이러한 문제를 개선하기 위해 RSTP(Rapid Spanning Tree Protocol), Port-fast, UpLink-Fast 등의 해결책이 개발되었다.
