# ğŸ‹ Docker - NginX - CertBot ğŸ‹

## ğŸ¦ Intor
ê³¼ê±° [EBMK](https://github.com/KIM-JS-95/PillIInfoService) í”„ë¡œì íŠ¸ì—ì„œ Dockerë¥¼ ë™í•´ CI/CD ì™€ ë¡œë“œ ë°¸ëŸ°ìŠ¤ë¥¼ êµ¬ì¶•í–ˆë‹¤.

ì™„ì „í•˜ì§€ëŠ” ëª»í–ˆì§€ë§Œ ì²« Docker ë°°í¬ë¼ëŠ” ì ì—ì„œ ë§ì€ê²ƒì„ ë°°ìš¸ ìˆ˜ ìˆì—ˆë‹¤.

![image](https://user-images.githubusercontent.com/65659478/182021192-3f46a9f0-4ead-4cae-b60a-714d5d86194b.png)

ê·¸ë¦¬ê³  ì´ë²ˆ MLP íŒŒì´ë„ í–¡ì—… í”„ë¡œì íŠ¸ì—ì„œëŠ” ë”ìš± ê²¬ê³ í•œ ë°°í¬ íŒŒì´í”„ ë¼ì¸ì„ êµ¬ì¶•í•˜ê¸° ìœ„í•´ ë§ì€ ê²ƒì„ ê°œì„ ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê³„ê¸°ê°€ ë˜ì—ˆë‹¤.

## ğŸ¦ Body
#### Geo Location í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ httpsë¥¼ ì ìš©í•˜ì„¸ìš”.

2015ë…„ë¶€í„° í¬ë¡¬ ê°œë°œìë“¤ì´ `HTTPì˜ ë³´ì•ˆë¬¸ì œ`ì— ëŒ€í•´ [ì´ìŠˆ](https://medium.com/witinweb/http-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%EC%82%AC%EC%9A%A9%EC%8B%9C-html5-geolocation-api-%EB%93%B1-%EC%9C%84%EC%B9%98%EC%A0%95%EB%B3%B4-%EC%82%AC%EC%9A%A9%EC%A0%9C%ED%95%9C%EC%97%90-%EB%8C%80%ED%95%98%EC%97%AC-e024772cc280)
ê°€ ë˜ë©´ì„œ **GeoLocation API ê¸°ëŠ¥ì œí•œ**ì— ëŒ€í•œ ë…¼ì˜ê°€ ì´ë£¨ì–´ì¡Œë‹¤.

ë‹¹ì—°í•˜ê²Œë„ ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê¸°ëŠ¥ì¤‘ í•˜ë‚˜ê°€ `Geo Loacation`ì´ì˜€ê³  ì„œë¹„ìŠ¤ í™˜ê²½ì„ HTTPSë¡œ ë³€ê²½í•´ì•¼í–ˆë‹¤.
ì •ë¦¬í•˜ìë©´ Docker ë°°í¬í™˜ê²½ì„ êµ¬ì¶•í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì¡°ê±´ì„ ë§Œì¡±í•´ì•¼í–ˆë‹¤.

```
1. Jenkins - Docker ê°„ì— ì†Œì¼“(Docker.sock) ì„ ì ìš©í•˜ì—¬ CDë¥¼ ì´ë£° ê²ƒ
2. Nginxë¥¼ ì ìš©í•˜ì—¬ LB(ë¡œë“œ ë°¸ëŸ°ìŠ¤)ë¥¼ êµ¬ì¶•í•  ê²ƒ
3. HTTPS ë¥¼ ì ìš©í•  ê²ƒ
```

#### SSL ì ìš©

SSLì„ ì ìš©í•˜ê¸° ìœ„í•´ NginXì— ë¬´ë£Œ SSLì„ ì ìš©í•  ìˆ˜ ìˆëŠ” `CertBot` ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í–ˆìœ¼ë©° [NginX - Certbot](https://github.com/wmnnd/nginx-certbot) ê°„í¸í•˜ê²Œ 
ì„ ì‚¬ìš©í•˜ë©´ í¸ë¦¬í•˜ê²Œ êµ¬ì¶•ì´ ê°€ëŠ¥í•˜ë‹¤.


#### Docker-compose ë¥¼ êµ¬ë¶„í•œ ì´ìœ ëŠ”?

Jenkins ì—ì„œ Build check í›„ Buildê°€ ìˆ˜í–‰ë˜ëŠ”ë° ì‹¤ì œ ì„œë¹„ìŠ¤ê°€ ìš´ì˜ëœë‹¤ëŠ” ê°€ì •í•˜ì— 
ë°°í¬ê°€ í•œë‹¬ì— 2ë²ˆ ì´ìƒì€ ìˆ˜í–‰ ë  ê²ƒì´ë©°, ë•Œë§ˆë‹¤ `Nginx`ì™€ `CertBot`ë¥¼ ReBuild í•˜ëŠ” ë²ˆê±°ë¡œì›€ì„ í”¼í•˜ê³  ì‹¶ì—ˆë‹¤.

ë•Œë¬¸ì— `SpringBoot Compose`ì™€ `NginX, CertBotë¥¼ Compose`ë¥¼ êµ¬ë¶„í•˜ì—¬ Spring ì€ Jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— ë°°ì¹˜í•˜ì—¬ Docker.sockìœ¼ë¡œ `DooD` êµ¬ì„±ì„ í–ˆê³ 
`HostOS`ì—ëŠ” `NginX - CertBot Compose`ë¥¼ ìœ„ì¹˜í•˜ì—¬ ìì›ì„ ê³µìœ í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í–ˆë‹¤.

#### SpringBoot Compose
```yaml

version: '3.0'
services:
  evrent1:
    container_name: evrent1
    build: .
    ports:
      - 9090:9090
    environment:
      MYSQL_HOST: 
      MYSQL_USER: 
      MYSQL_PASSWORD: 
      MYSQL_PORT: 3306
    volumes:
      - .:/usr/src
    restart:
      always
    depends_on:
      - mysql

  evrent2:
    container_name: evrent2
    build: .
    ports:
      - 9091:9090
    environment:
      MYSQL_HOST:
      MYSQL_USER: 
      MYSQL_PASSWORD:
      MYSQL_PORT: 3306
    volumes:
      - .:/usr/src
    restart:
      always
    depends_on:
      - mysql

  mysql:
    container_name: mysql
    image: mysql
    environment:
      MYSQL_DATABASE:
      MYSQL_ROOT_PASSWORD:
    volumes:
      - "/var/lib/mysql:/docker-entrypoint-initdb.d"
    ports:
      - 3307:3306
```

![image](https://user-images.githubusercontent.com/65659478/182024040-c3379280-a7f0-4b1b-8f05-748428a8a1d0.png)


## ë¯¸í•´ê²° ì—ëŸ¬

![image](https://user-images.githubusercontent.com/65659478/182028817-6533fe62-f4b8-47a7-9cec-ec21754dd1b4.png)

NginX - CertBot ì„ Compose í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ `HTTPS`ê°€ ì ìš©ë˜ì—ˆì§€ë§Œ **ì¸ì¦ë˜ì§€ ì•Šì€ ì¸ì¦ì„œê°€ ì‚¬ìš©ë˜ì—ˆë‹¤ëŠ” ì£¼ì˜**ê°€ í™”ë©´ì— ë³´ì—¬ì§„ë‹¤.

ê¸°ëŠ¥ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥ í•œê²ƒì€ ì•„ë‹ˆì§€ë§Œ ê¹”ë”í•œ ê²°ê³¼ê°€ ë³´ì—¬ì§€ì§€ ëª»í•´ ì•„ì‰½ë‹¤.

ê²°êµ­ í•´ê²°í•˜ì§€ëŠ” ëª»í–ˆì§€ë§Œ ì˜¤ë²„í”Œë¡œìš° ì—ì„œëŠ” ìœ ë£Œ SSL ì‚¬ìš©ì„ ê¶Œì¥í•˜ë©° CertBotì— ëŒ€í•œ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ì˜ ì›ì¸ì„ í•´ê²°í•œ ê°œë°œìëŠ” ì—†ëŠ” ë“¯ í•˜ë‹¤.



```shell
upstream evrent {
        least_conn;
        server evrent1:9090;
        server evrent2:9091;
   }

    server {
        listen      80 default_server;
        server_name evrent.ml;

    location /.well-known/acme-challenge/ {
        allow all;
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }

    }

server {
    listen 443 ssl;
    server_name evrent.ml;
        server_tokens off;

    ssl_certificate /etc/letsencrypt/live/evrent.ml/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/evrent.ml/privkey.pem;

    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;



    location / {
                proxy_pass http://evrent;
                proxy_set_header   Host             $http_host;
                proxy_set_header   X-Real-IP        $remote_addr;
                proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

                proxy_buffering off;
                proxy_buffer_size 16k;
                proxy_busy_buffers_size 24k;
                proxy_buffers 64 4k;
}
}

```

## Conclusion

compose ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´í•´í•˜ê³  êµ¬ì„±í•˜ë©° í˜„ì¬ í™˜ê²½ì—ì„œ ìŠ¤ìŠ¤ë¡œê°€ ê³„íší•œ ë¡œë“œë§µ êµ¬í˜„ì— ì„±ê³µí•˜ë©´ì„œ
2ë‹¬ì „ê³¼ ë¹„êµí•˜ë©´ ì´ì œëŠ” Dockerë¥¼ ë‹¤ë£¨ëŠ” ëŠ¥ë ¥ì´ í–¥ìƒëœê±¸ ëŠë‚€ë‹¤.

ê·¸ëŸ¼ì—ë„ Volumeì„ ë‹¤ë£¨ëŠ” ê²ƒì€ ì•„ì§ê¹Œì§€ë„ ì–´ë ¤ìš°ë©° 
ì‹¤ì œ ì„œë¹„ìŠ¤ëŠ” ë”ìš± ë³µì¡í•˜ë©° ì„œë¹„ìŠ¤ë¥¼ ì„¸ë¶„í™”í•˜ì—¬ ê´€ë¦¬í•  í…Œë‹ˆ ê¸°ì´ˆë¥¼ ë‹¤ì‹œ í•œë²ˆ ê³µë¶€í•˜ëŠ” ì‹œê°„ì„ ê°€ì§€ëŠ” ê²ƒë„ ì¢‹ì„ ë“¯í•˜ë‹¤. 


## Refference
- [My Repository](https://github.com/KIM-JS-95/Rent-Car-electronic)
- [http í”„ë¡œí† ì½œ ì‚¬ìš©ì‹œ HTML5 Geolocation API ë“± ìœ„ì¹˜ì •ë³´ ì‚¬ìš©ì œí•œì— ëŒ€í•˜ì—¬](https://medium.com/witinweb/http-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%EC%82%AC%EC%9A%A9%EC%8B%9C-html5-geolocation-api-%EB%93%B1-%EC%9C%84%EC%B9%98%EC%A0%95%EB%B3%B4-%EC%82%AC%EC%9A%A9%EC%A0%9C%ED%95%9C%EC%97%90-%EB%8C%80%ED%95%98%EC%97%AC-e024772cc280)